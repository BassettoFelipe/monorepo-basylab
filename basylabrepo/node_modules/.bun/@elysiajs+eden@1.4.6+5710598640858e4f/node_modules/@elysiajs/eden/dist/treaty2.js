"use strict";var D=Object.defineProperty;var Z=Object.getOwnPropertyDescriptor;var z=Object.getOwnPropertyNames;var Q=Object.prototype.hasOwnProperty;var X=(e,t)=>{for(var n in t)D(e,n,{get:t[n],enumerable:!0})},Y=(e,t,n,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of z(t))!Q.call(e,i)&&i!==n&&D(e,i,{get:()=>t[i],enumerable:!(r=Z(t,i))||r.enumerable});return e};var ee=e=>Y(D({},"__esModule",{value:!0}),e);var ue={};X(ue,{streamResponse:()=>_,treaty:()=>fe});module.exports=ee(ue);var k=class extends Error{constructor(n,r){super(r+"");this.status=n;this.value=r}};var te=/(\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d:[0-5]\d\.\d+([+-][0-2]\d:[0-5]\d|Z))|(\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d:[0-5]\d([+-][0-2]\d:[0-5]\d|Z))|(\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d([+-][0-2]\d:[0-5]\d|Z))/,ne=/(?:Sun|Mon|Tue|Wed|Thu|Fri|Sat)\s(?:Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\s\d{2}\s\d{4}\s\d{2}:\d{2}:\d{2}\sGMT(?:\+|-)\d{4}\s\([^)]+\)/,re=/^(?:(?:(?:(?:0?[1-9]|[12][0-9]|3[01])[/\s-](?:0?[1-9]|1[0-2])[/\s-](?:19|20)\d{2})|(?:(?:19|20)\d{2}[/\s-](?:0?[1-9]|1[0-2])[/\s-](?:0?[1-9]|[12][0-9]|3[01]))))(?:\s(?:1[012]|0?[1-9]):[0-5][0-9](?::[0-5][0-9])?(?:\s[AP]M)?)?$/,se=e=>e.trim().length!==0&&!Number.isNaN(Number(e)),T=e=>{if(typeof e!="string")return null;let t=e.replace(/"/g,"");if(te.test(t)||ne.test(t)||re.test(t)){let n=new Date(t);if(!Number.isNaN(n.getTime()))return n}return null},ie=e=>{let t=e.charCodeAt(0),n=e.charCodeAt(e.length-1);return t===123&&n===125||t===91&&n===93},ae=e=>JSON.parse(e,(t,n)=>{let r=T(n);return r||n}),W=e=>{if(!e)return e;if(se(e))return+e;if(e==="true")return!0;if(e==="false")return!1;let t=T(e);if(t)return t;if(ie(e))try{return ae(e)}catch{}return e},q=e=>{let t=e.data.toString();return t==="null"?null:W(t)};var M=class{constructor(t){this.url=t;this.ws=new WebSocket(t)}ws;send(t){return Array.isArray(t)?(t.forEach(n=>this.send(n)),this):(this.ws.send(typeof t=="object"?JSON.stringify(t):t.toString()),this)}on(t,n,r){return this.addEventListener(t,n,r)}off(t,n,r){return this.ws.removeEventListener(t,n,r),this}subscribe(t,n){return this.addEventListener("message",t,n)}addEventListener(t,n,r){return this.ws.addEventListener(t,i=>{if(t==="message"){let u=q(i);n({...i,data:u})}else n(i)},r),this}removeEventListener(t,n,r){return this.off(t,n,r),this}close(){return this.ws.close(),this}};var oe=["get","post","put","delete","patch","options","head","connect","subscribe"],V=["localhost","127.0.0.1","0.0.0.0"],J=typeof FileList>"u",C=e=>J?e instanceof Blob:e instanceof FileList||e instanceof File,ce=e=>{if(!e)return!1;for(let t in e)if(C(e[t])||Array.isArray(e[t])&&e[t].find(C))return!0;return!1},K=e=>J?e:new Promise(t=>{let n=new FileReader;n.onload=()=>{let r=new File([n.result],e.name,{lastModified:e.lastModified,type:e.type});t(r)},n.readAsArrayBuffer(e)}),E=async(e,t,n={},r={})=>{if(Array.isArray(e)){for(let i of e)if(!Array.isArray(i))r=await E(i,t,n,r);else{let u=i[0];if(typeof u=="string")r[u.toLowerCase()]=i[1];else for(let[a,y]of u)r[a.toLowerCase()]=y}return r}if(!e)return r;switch(typeof e){case"function":if(e instanceof Headers)return E(e,t,n,r);let i=await e(t,n);return i?E(i,t,n,r):r;case"object":if(e instanceof Headers)return e.forEach((u,a)=>{r[a.toLowerCase()]=u}),r;for(let[u,a]of Object.entries(e))r[u.toLowerCase()]=a;return r;default:return r}};function B(e){let t=e.split(`
`),n={};for(let r of t){if(!r||r.startsWith(":"))continue;let i=r.indexOf(":");if(i>0){let u=r.slice(0,i).trim(),a=r.slice(i+1).replace(/^ /,"");n[u]=a&&W(a)}}return Object.keys(n).length>0?n:null}function*P(e){let t;for(;(t=e.value.indexOf(`

`))!==-1;){let n=e.value.slice(0,t);if(e.value=e.value.slice(t+2),n.trim()){let r=B(n);r&&(yield r)}}}async function*_(e){let t=e.body;if(!t)return;let n=t.getReader(),r=new TextDecoder("utf-8"),i={value:""};try{for(;;){let{done:a,value:y}=await n.read();if(a)break;let R=typeof y=="string"?y:r.decode(y,{stream:!0});i.value+=R,yield*P(i)}let u=r.decode();if(u&&(i.value+=u),yield*P(i),i.value.trim()){let a=B(i.value);a&&(yield a)}}finally{n.releaseLock()}}var F=(e,t,n=[],r)=>new Proxy(()=>{},{get(i,u){return F(e,t,u==="index"?n:[...n,u],r)},apply(i,u,[a,y]){if(!a||y||typeof a=="object"&&Object.keys(a).length!==1||oe.includes(n.at(-1))){let R=[...n],x=R.pop(),m="/"+R.join("/"),{fetcher:H=fetch,headers:L,onRequest:w,onResponse:O,fetch:U}=t,v=x==="get"||x==="head"||x==="subscribe",I=v?a?.query:y?.query,N="";if(I){let s=(b,p)=>{N+=(N?"&":"?")+`${encodeURIComponent(b)}=${encodeURIComponent(p)}`};for(let[b,p]of Object.entries(I)){if(Array.isArray(p)){for(let f of p)s(b,f);continue}if(p!=null){if(typeof p=="object"){s(b,JSON.stringify(p));continue}s(b,`${p}`)}}}if(x==="subscribe"){let s=e.replace(/^([^]+):\/\//,e.startsWith("https://")?"wss://":e.startsWith("http://")||V.find(b=>e.includes(b))?"ws://":"wss://")+m+N;return new M(s)}return(async()=>{L=await E(L,m,y);let s={method:x?.toUpperCase(),body:a,...U,headers:L};s.headers={...L,...await E(v?a?.headers:y?.headers,m,s)};let b=v&&typeof a=="object"?a.fetch:y?.fetch;if(s={...s,...b},v&&delete s.body,w){Array.isArray(w)||(w=[w]);for(let d of w){let c=await d(m,s);typeof c=="object"&&(s={...s,...c,headers:{...s.headers,...await E(c.headers,m,s)}})}}if(v&&delete s.body,ce(a)){let d=new FormData,c=o=>{if(typeof o=="string"||C(o))return!1;if(typeof o=="object"){if(o!==null)return!0;if(o instanceof Date)return!1}return!1},h=async o=>o instanceof File?await K(o):c(o)?JSON.stringify(o):o;for(let[o,l]of Object.entries(s.body)){if(Array.isArray(l)){if(l.some(S=>typeof S=="object"&&S!==null&&!C(S)))d.append(o,JSON.stringify(l));else for(let S=0;S<l.length;S++){let $=l[S],G=await h($);d.append(o,G)}continue}if(J){if(Array.isArray(l))for(let A of l)d.append(o,await h(A));else d.append(o,await h(l));continue}if(l instanceof File){d.append(o,await K(l));continue}if(l instanceof FileList){for(let A=0;A<l.length;A++)d.append(o,await K(l[A]));continue}d.append(o,await h(l))}s.body=d}else typeof a=="object"?(s.headers["content-type"]="application/json",s.body=JSON.stringify(a)):a!=null&&(s.headers["content-type"]="text/plain");if(v&&delete s.body,w){Array.isArray(w)||(w=[w]);for(let d of w){let c=await d(m,s);typeof c=="object"&&(s={...s,...c,headers:{...s.headers,...await E(c.headers,m,s)}})}}y?.headers?.["content-type"]&&(s.headers["content-type"]=y?.headers["content-type"]);let p=e+m+N,f;try{f=await(r?.handle(new Request(p,s))??H(p,s))}catch(d){return{data:null,error:new k(503,d),response:void 0,status:503,headers:void 0}}let g=null,j=null;if(O){Array.isArray(O)||(O=[O]);for(let d of O)try{let c=await d(f.clone());if(c!=null){g=c;break}}catch(c){c instanceof k?j=c:j=new k(422,c);break}}if(g!==null)return{data:g,error:j,response:f,status:f.status,headers:f.headers};switch(f.headers.get("Content-Type")?.split(";")[0]){case"text/event-stream":g=_(f);break;case"application/json":g=JSON.parse(await f.text(),(c,h)=>{if(typeof h!="string")return h;let o=T(h);return o||h});break;case"application/octet-stream":g=await f.arrayBuffer();break;case"multipart/form-data":let d=await f.formData();g={},d.forEach((c,h)=>{g[h]=c});break;default:g=await f.text().then(W)}return(f.status>=300||f.status<200)&&(j=new k(f.status,g),g=null),{data:g,error:j,response:f,status:f.status,headers:f.headers}})()}return typeof a=="object"?F(e,t,[...n,Object.values(a)[0]],r):F(e,t,n)}}),fe=(e,t={})=>typeof e=="string"?(t.keepDomain||(e.includes("://")||(e=(V.find(n=>e.includes(n))?"http://":"https://")+e),e.endsWith("/")&&(e=e.slice(0,-1))),F(e,t)):(typeof window<"u"&&console.warn("Elysia instance server found on client side, this is not recommended for security reason. Use generic type instead."),F("http://e.ly",t,[],e));0&&(module.exports={streamResponse,treaty});
